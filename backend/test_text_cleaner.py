#!/usr/bin/env python3
"""
æ–‡æœ¬æ¸…ç†æµ‹è¯•è„šæœ¬
éªŒè¯æ–‡æœ¬æ¸…ç†æœåŠ¡çš„æ•ˆæœ
"""
import sys
import os

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.services.text_cleaner import text_cleaner

def test_text_cleaner():
    """æµ‹è¯•æ–‡æœ¬æ¸…ç†åŠŸèƒ½"""
    print("ğŸ§ª æ–‡æœ¬æ¸…ç†æµ‹è¯•")
    print("=" * 60)
    
    # æµ‹è¯•ç”¨ä¾‹
    test_cases = [
        {
            "name": "è¡¨æƒ…ç¬¦å·æµ‹è¯•",
            "input": "ä½ å¥½ğŸ˜Šï¼ä»Šå¤©å¤©æ°”çœŸä¸é”™ğŸŒï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è‚¡ç¥¨ğŸ“ˆå§ï¼",
            "expected": "ä½ å¥½ï¼ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è‚¡ç¥¨å§ã€‚"
        },
        {
            "name": "æ ‡é¢˜æ ¼å¼æµ‹è¯•",
            "input": "# è‚¡ç¥¨äº¤æ˜“æŒ‡å—\n## 1. å¼€æˆ·æµç¨‹\n### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ææ–™",
            "expected": "è‚¡ç¥¨äº¤æ˜“æŒ‡å—ï¼Œå¼€æˆ·æµç¨‹ï¼Œç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ææ–™ã€‚"
        },
        {
            "name": "åˆ—è¡¨æ ¼å¼æµ‹è¯•",
            "input": "äº¤æ˜“æ­¥éª¤ï¼š\n1. æ³¨å†Œè´¦æˆ·\n2. å®åè®¤è¯\n3. å……å€¼èµ„é‡‘\n4. å¼€å§‹äº¤æ˜“",
            "expected": "äº¤æ˜“æ­¥éª¤ï¼šç¬¬1ä¸ªï¼Œæ³¨å†Œè´¦æˆ·ï¼Œç¬¬2ä¸ªï¼Œå®åè®¤è¯ï¼Œç¬¬3ä¸ªï¼Œå……å€¼èµ„é‡‘ï¼Œç¬¬4ä¸ªï¼Œå¼€å§‹äº¤æ˜“ã€‚"
        },
        {
            "name": "ç‰¹æ®Šç¬¦å·æµ‹è¯•",
            "input": "ã€é‡è¦æç¤ºã€‘è¯·ä»”ç»†é˜…è¯»ã€Šç”¨æˆ·åè®®ã€‹ï¼ˆç¬¬3æ¡ï¼‰å’Œã€Šé£é™©æç¤ºã€‹",
            "expected": "é‡è¦æç¤ºï¼Œè¯·ä»”ç»†é˜…è¯»ï¼Œç”¨æˆ·åè®®ï¼Œç¬¬3æ¡ï¼Œå’Œï¼Œé£é™©æç¤ºã€‚"
        },
        {
            "name": "é‡å¤æ ‡ç‚¹æµ‹è¯•",
            "input": "å¤ªæ£’äº†ï¼ï¼ï¼è¿™ä¸ªåŠŸèƒ½çœŸçš„å¾ˆå¥½ï¼Ÿï¼Ÿï¼Ÿ",
            "expected": "å¤ªæ£’äº†ï¼è¿™ä¸ªåŠŸèƒ½çœŸçš„å¾ˆå¥½ï¼Ÿ"
        },
        {
            "name": "å¤æ‚æ ¼å¼æµ‹è¯•",
            "input": """# è‚¡ç¥¨æŠ•èµ„æŒ‡å— ğŸ“ˆ
            
## æŠ•èµ„æ­¥éª¤ï¼š
1. **å¼€æˆ·** - é€‰æ‹©è¯åˆ¸å…¬å¸
2. **è®¤è¯** - å®Œæˆå®åè®¤è¯  
3. **å……å€¼** - å­˜å…¥èµ„é‡‘
4. **äº¤æ˜“** - å¼€å§‹ä¹°å–è‚¡ç¥¨

æ³¨æ„äº‹é¡¹ï¼š
â€¢ æŠ•èµ„æœ‰é£é™© âš ï¸
â€¢ è¯·è°¨æ…æ“ä½œ ğŸ’¡
â€¢ å»ºè®®å­¦ä¹ ç›¸å…³çŸ¥è¯† ğŸ“š"""
        },
        {
            "name": "å®é™…AIå›å¤æµ‹è¯•",
            "input": """æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ ğŸ˜Š

å…³äºå¼€æˆ·æµç¨‹ï¼Œæˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»ï¼š

## å¼€æˆ·æ­¥éª¤ï¼š
1. **é€‰æ‹©è¯åˆ¸å…¬å¸** - æ¨èå¤§å‹åˆ¸å•†
2. **å‡†å¤‡èº«ä»½è¯** - ç¡®ä¿åœ¨æœ‰æ•ˆæœŸå†…
3. **ä¸‹è½½APP** - ä»å®˜æ–¹æ¸ é“ä¸‹è½½
4. **åœ¨çº¿å¼€æˆ·** - æŒ‰æç¤ºå®Œæˆæ“ä½œ

## æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ è¯·ç¡®ä¿ç½‘ç»œç¯å¢ƒå®‰å…¨
ğŸ’¡ å»ºè®®åœ¨è¥ä¸šæ—¶é—´æ“ä½œ
ğŸ“ å¦‚æœ‰é—®é¢˜å¯è”ç³»å®¢æœ

å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹æ‚¨æœ‰å¸®åŠ©ï¼ ğŸ‰"""
        }
    ]
    
    for i, test_case in enumerate(test_cases, 1):
        print(f"\n--- æµ‹è¯• {i}: {test_case['name']} ---")
        print(f"ğŸ“ åŸå§‹æ–‡æœ¬:")
        print(f"   {test_case['input']}")
        
        # æ‰§è¡Œæ¸…ç†
        cleaned = text_cleaner.clean_for_tts(test_case['input'])
        
        print(f"ğŸ§¹ æ¸…ç†åæ–‡æœ¬:")
        print(f"   {cleaned}")
        
        # æ£€æŸ¥æ•ˆæœ
        if cleaned.strip():
            print(f"âœ… æ¸…ç†æˆåŠŸï¼Œé•¿åº¦: {len(cleaned)} å­—ç¬¦")
        else:
            print(f"âŒ æ¸…ç†åæ–‡æœ¬ä¸ºç©º")
        
        print("-" * 50)

def test_sentence_splitting():
    """æµ‹è¯•å¥å­åˆ†å‰²åŠŸèƒ½"""
    print("\nğŸ” å¥å­åˆ†å‰²æµ‹è¯•")
    print("=" * 60)
    
    test_text = """æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ã€‚å…³äºå¼€æˆ·æµç¨‹ï¼Œæˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»ã€‚é¦–å…ˆï¼Œæ‚¨éœ€è¦é€‰æ‹©ä¸€å®¶è¯åˆ¸å…¬å¸ã€‚ç„¶åï¼Œå‡†å¤‡èº«ä»½è¯ç­‰ææ–™ã€‚æœ€åï¼ŒæŒ‰ç…§APPæç¤ºå®Œæˆå¼€æˆ·æ“ä½œã€‚æ•´ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦10åˆ†é’Ÿã€‚"""
    
    print(f"ğŸ“ åŸå§‹æ–‡æœ¬:")
    print(f"   {test_text}")
    
    sentences = text_cleaner.split_into_sentences(test_text)
    
    print(f"\nğŸ“‹ åˆ†å‰²ç»“æœ:")
    for i, sentence in enumerate(sentences, 1):
        print(f"   {i}. {sentence}")
    
    print(f"\nâœ… å…±åˆ†å‰²å‡º {len(sentences)} ä¸ªå¥å­")

def test_performance():
    """æµ‹è¯•æ€§èƒ½"""
    print("\nâš¡ æ€§èƒ½æµ‹è¯•")
    print("=" * 60)
    
    import time
    
    # ç”Ÿæˆæµ‹è¯•æ–‡æœ¬
    test_text = """# è‚¡ç¥¨æŠ•èµ„æŒ‡å— ğŸ“ˆ

## æŠ•èµ„æ­¥éª¤ï¼š
1. **å¼€æˆ·** - é€‰æ‹©è¯åˆ¸å…¬å¸ ğŸ˜Š
2. **è®¤è¯** - å®Œæˆå®åè®¤è¯ âš¡
3. **å……å€¼** - å­˜å…¥èµ„é‡‘ ğŸ’°
4. **äº¤æ˜“** - å¼€å§‹ä¹°å–è‚¡ç¥¨ ğŸ“Š

æ³¨æ„äº‹é¡¹ï¼š
â€¢ æŠ•èµ„æœ‰é£é™© âš ï¸
â€¢ è¯·è°¨æ…æ“ä½œ ğŸ’¡
â€¢ å»ºè®®å­¦ä¹ ç›¸å…³çŸ¥è¯† ğŸ“š

ã€é‡è¦æç¤ºã€‘è¯·ä»”ç»†é˜…è¯»ã€Šç”¨æˆ·åè®®ã€‹ï¼ˆç¬¬3æ¡ï¼‰å’Œã€Šé£é™©æç¤ºã€‹ï¼ï¼ï¼

å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹æ‚¨æœ‰å¸®åŠ©ï¼ ğŸ‰"""
    
    print(f"ğŸ“ æµ‹è¯•æ–‡æœ¬é•¿åº¦: {len(test_text)} å­—ç¬¦")
    
    # æµ‹è¯•æ¸…ç†æ€§èƒ½
    start_time = time.time()
    for _ in range(100):
        cleaned = text_cleaner.clean_for_tts(test_text)
    end_time = time.time()
    
    avg_time = (end_time - start_time) / 100 * 1000  # è½¬æ¢ä¸ºæ¯«ç§’
    print(f"â±ï¸  å¹³å‡æ¸…ç†æ—¶é—´: {avg_time:.2f} æ¯«ç§’")
    
    print(f"ğŸ§¹ æ¸…ç†åæ–‡æœ¬:")
    print(f"   {cleaned}")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ æ–‡æœ¬æ¸…ç†æœåŠ¡æµ‹è¯•")
    print("=" * 60)
    
    try:
        # åŸºç¡€åŠŸèƒ½æµ‹è¯•
        test_text_cleaner()
        
        # å¥å­åˆ†å‰²æµ‹è¯•
        test_sentence_splitting()
        
        # æ€§èƒ½æµ‹è¯•
        test_performance()
        
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ!")
        
    except Exception as e:
        print(f"\nâŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main() 