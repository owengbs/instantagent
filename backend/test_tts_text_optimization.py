#!/usr/bin/env python3
"""
TTSæ–‡æœ¬ä¼˜åŒ–æµ‹è¯•
ä¸“é—¨æµ‹è¯•æ–‡æœ¬æ¸…ç†å¯¹TTSè¯­éŸ³åˆæˆçš„å½±å“
"""
import sys
import os

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.services.text_cleaner import text_cleaner

def test_tts_optimization():
    """æµ‹è¯•TTSæ–‡æœ¬ä¼˜åŒ–æ•ˆæœ"""
    print("ğŸ¤ TTSæ–‡æœ¬ä¼˜åŒ–æµ‹è¯•")
    print("=" * 60)
    
    # æ¨¡æ‹Ÿå¤§æ¨¡å‹è¾“å‡ºçš„å„ç§æƒ…å†µ
    test_cases = [
        {
            "name": "åŸºç¡€å¯¹è¯æµ‹è¯•",
            "input": "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ ğŸ˜Šï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼",
            "description": "åŒ…å«è¡¨æƒ…ç¬¦å·çš„ç®€å•å¯¹è¯"
        },
        {
            "name": "åˆ—è¡¨æ ¼å¼æµ‹è¯•",
            "input": """å¼€æˆ·æµç¨‹å¦‚ä¸‹ï¼š
1. é€‰æ‹©è¯åˆ¸å…¬å¸
2. å‡†å¤‡èº«ä»½è¯
3. ä¸‹è½½APP
4. åœ¨çº¿å¼€æˆ·

æ³¨æ„äº‹é¡¹ï¼š
â€¢ ç¡®ä¿ç½‘ç»œå®‰å…¨
â€¢ è¥ä¸šæ—¶é—´æ“ä½œ
â€¢ æœ‰é—®é¢˜è”ç³»å®¢æœ""",
            "description": "åŒ…å«åˆ—è¡¨å’Œé¡¹ç›®ç¬¦å·çš„è¯´æ˜"
        },
        {
            "name": "æ ‡é¢˜æ ¼å¼æµ‹è¯•",
            "input": """# è‚¡ç¥¨æŠ•èµ„æŒ‡å—

## æŠ•èµ„æ­¥éª¤ï¼š
### ç¬¬ä¸€æ­¥ï¼šå¼€æˆ·
é€‰æ‹©å¤§å‹è¯åˆ¸å…¬å¸ï¼Œå¦‚ä¸­ä¿¡è¯åˆ¸ã€åæ³°è¯åˆ¸ç­‰ã€‚

### ç¬¬äºŒæ­¥ï¼šå­¦ä¹ 
å»ºè®®å…ˆå­¦ä¹ åŸºç¡€çŸ¥è¯†ï¼Œäº†è§£é£é™©ã€‚

### ç¬¬ä¸‰æ­¥ï¼šå°èµ„é‡‘è¯•æ°´
å»ºè®®å…ˆç”¨å°èµ„é‡‘ç»ƒä¹ ï¼Œç†Ÿæ‚‰æ“ä½œæµç¨‹ã€‚""",
            "description": "åŒ…å«Markdownæ ‡é¢˜æ ¼å¼çš„å†…å®¹"
        },
        {
            "name": "ç‰¹æ®Šç¬¦å·æµ‹è¯•",
            "input": "ã€é‡è¦æç¤ºã€‘è¯·ä»”ç»†é˜…è¯»ã€Šç”¨æˆ·åè®®ã€‹ï¼ˆç¬¬3æ¡ï¼‰å’Œã€Šé£é™©æç¤ºã€‹âš ï¸ï¼ŒæŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ï¼",
            "description": "åŒ…å«å„ç§ç‰¹æ®Šç¬¦å·å’Œæ‹¬å·çš„å†…å®¹"
        },
        {
            "name": "å¤æ‚æ ¼å¼æµ‹è¯•",
            "input": """# è‚¡ç¥¨äº¤æ˜“å®Œæ•´æŒ‡å— ğŸ“ˆ

## å¼€æˆ·æµç¨‹ï¼š
1. **é€‰æ‹©åˆ¸å•†** - æ¨èå¤§å‹åˆ¸å•†ï¼ˆå¦‚ä¸­ä¿¡ã€åæ³°ï¼‰
2. **å‡†å¤‡ææ–™** - èº«ä»½è¯ã€é“¶è¡Œå¡
3. **ä¸‹è½½APP** - ä»å®˜æ–¹æ¸ é“ä¸‹è½½
4. **åœ¨çº¿å¼€æˆ·** - æŒ‰æç¤ºå®Œæˆæ“ä½œ

## äº¤æ˜“æ­¥éª¤ï¼š
â€¢ å……å€¼èµ„é‡‘ ğŸ’°
â€¢ é€‰æ‹©è‚¡ç¥¨ ğŸ“Š
â€¢ ä¸‹å•äº¤æ˜“ âš¡
â€¢ ç›‘æ§æŒä»“ ğŸ‘€

## é£é™©æç¤ºï¼š
âš ï¸ æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ï¼
ğŸ’¡ å»ºè®®å…ˆå­¦ä¹ åŸºç¡€çŸ¥è¯†
ğŸ“š å¯ä»¥å‚åŠ åŸ¹è®­è¯¾ç¨‹

å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹æ‚¨æœ‰å¸®åŠ©ï¼ ğŸ‰""",
            "description": "åŒ…å«å¤æ‚æ ¼å¼ã€è¡¨æƒ…ç¬¦å·ã€åˆ—è¡¨çš„å®Œæ•´å†…å®¹"
        },
        {
            "name": "å®é™…AIå›å¤æ¨¡æ‹Ÿ",
            "input": """æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ ğŸ˜Š

å…³äºæ‚¨è¯¢é—®çš„å¼€æˆ·æµç¨‹ï¼Œæˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»ï¼š

## å¼€æˆ·æ­¥éª¤ï¼š
1. **é€‰æ‹©è¯åˆ¸å…¬å¸** - æˆ‘æ¨èæ‚¨é€‰æ‹©å¤§å‹åˆ¸å•†ï¼Œæ¯”å¦‚ä¸­ä¿¡è¯åˆ¸ã€åæ³°è¯åˆ¸ç­‰ï¼Œè¿™äº›åˆ¸å•†æœåŠ¡æ¯”è¾ƒå®Œå–„
2. **å‡†å¤‡èº«ä»½è¯** - è¯·ç¡®ä¿æ‚¨çš„èº«ä»½è¯åœ¨æœ‰æ•ˆæœŸå†…ï¼Œè¿™æ˜¯å¼€æˆ·çš„å¿…å¤‡ææ–™
3. **ä¸‹è½½APP** - è¯·ä»å®˜æ–¹æ¸ é“ä¸‹è½½äº¤æ˜“APPï¼Œé¿å…ä½¿ç”¨ç¬¬ä¸‰æ–¹è½¯ä»¶
4. **åœ¨çº¿å¼€æˆ·** - æŒ‰ç…§APPæç¤ºå®Œæˆå¼€æˆ·æ“ä½œï¼Œæ•´ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦10åˆ†é’Ÿ

## æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ è¯·ç¡®ä¿ç½‘ç»œç¯å¢ƒå®‰å…¨ï¼Œä¸è¦åœ¨å…¬å…±WiFiä¸‹æ“ä½œ
ğŸ’¡ å»ºè®®åœ¨è¥ä¸šæ—¶é—´ï¼ˆ9:00-15:00ï¼‰è¿›è¡Œæ“ä½œ
ğŸ“ å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥è”ç³»å®¢æœçƒ­çº¿

## åç»­å»ºè®®ï¼š
â€¢ å¼€æˆ·æˆåŠŸåï¼Œå»ºè®®å…ˆå­¦ä¹ åŸºç¡€çŸ¥è¯†
â€¢ å¯ä»¥å…ˆç”¨å°èµ„é‡‘ç»ƒä¹ ï¼Œç†Ÿæ‚‰æ“ä½œæµç¨‹
â€¢ æŠ•èµ„æœ‰é£é™©ï¼Œè¯·è°¨æ…æ“ä½œ

å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹æ‚¨æœ‰å¸®åŠ©ï¼å¦‚æœè¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œéšæ—¶å¯ä»¥é—®æˆ‘ ğŸ‰""",
            "description": "æ¨¡æ‹ŸçœŸå®çš„AIå›å¤å†…å®¹"
        }
    ]
    
    for i, test_case in enumerate(test_cases, 1):
        print(f"\n--- æµ‹è¯• {i}: {test_case['name']} ---")
        print(f"ğŸ“ æè¿°: {test_case['description']}")
        print(f"ğŸ“ åŸå§‹æ–‡æœ¬ ({len(test_case['input'])} å­—ç¬¦):")
        print(f"   {test_case['input']}")
        
        # æ‰§è¡ŒTTSä¼˜åŒ–æ¸…ç†
        cleaned = text_cleaner.clean_for_tts(test_case['input'])
        
        print(f"ğŸ¤ TTSä¼˜åŒ–å ({len(cleaned)} å­—ç¬¦):")
        print(f"   {cleaned}")
        
        # åˆ†æä¼˜åŒ–æ•ˆæœ
        original_length = len(test_case['input'])
        cleaned_length = len(cleaned)
        reduction = original_length - cleaned_length
        reduction_rate = (reduction / original_length) * 100 if original_length > 0 else 0
        
        print(f"ğŸ“Š ä¼˜åŒ–ç»Ÿè®¡:")
        print(f"   - å­—ç¬¦å‡å°‘: {reduction} ä¸ª ({reduction_rate:.1f}%)")
        print(f"   - æ¸…ç†æ•ˆæœ: {'âœ… è‰¯å¥½' if reduction_rate > 10 else 'âš ï¸ ä¸€èˆ¬'}")
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸é€‚åˆTTSçš„å†…å®¹
        problematic_chars = []
        for char in cleaned:
            if ord(char) > 127 and char not in 'ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š':
                problematic_chars.append(char)
        
        if problematic_chars:
            print(f"   - å‰©ä½™é—®é¢˜å­—ç¬¦: {set(problematic_chars)}")
        else:
            print(f"   - âœ… æ— é—®é¢˜å­—ç¬¦")
        
        print("-" * 50)

def test_sentence_flow():
    """æµ‹è¯•å¥å­æµç•…åº¦"""
    print("\nğŸŒŠ å¥å­æµç•…åº¦æµ‹è¯•")
    print("=" * 60)
    
    test_texts = [
        "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ã€‚å…³äºå¼€æˆ·æµç¨‹ï¼Œæˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»ã€‚é¦–å…ˆï¼Œæ‚¨éœ€è¦é€‰æ‹©ä¸€å®¶è¯åˆ¸å…¬å¸ã€‚ç„¶åï¼Œå‡†å¤‡èº«ä»½è¯ç­‰ææ–™ã€‚æœ€åï¼ŒæŒ‰ç…§APPæç¤ºå®Œæˆå¼€æˆ·æ“ä½œã€‚æ•´ä¸ªè¿‡ç¨‹å¤§çº¦éœ€è¦10åˆ†é’Ÿã€‚",
        "æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…ï¼è¯·ç¡®ä¿ç½‘ç»œç¯å¢ƒå®‰å…¨ï¼Œå»ºè®®åœ¨è¥ä¸šæ—¶é—´æ“ä½œã€‚å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥è”ç³»å®¢æœçƒ­çº¿ã€‚",
        "å¼€æˆ·æ­¥éª¤ï¼šé€‰æ‹©è¯åˆ¸å…¬å¸ï¼Œå‡†å¤‡èº«ä»½è¯ï¼Œä¸‹è½½APPï¼Œåœ¨çº¿å¼€æˆ·ã€‚æ³¨æ„äº‹é¡¹ï¼šç¡®ä¿ç½‘ç»œå®‰å…¨ï¼Œè¥ä¸šæ—¶é—´æ“ä½œï¼Œæœ‰é—®é¢˜è”ç³»å®¢æœã€‚"
    ]
    
    for i, text in enumerate(test_texts, 1):
        print(f"\n--- æµ‹è¯• {i} ---")
        print(f"ğŸ“ åŸå§‹æ–‡æœ¬:")
        print(f"   {text}")
        
        # åˆ†å‰²å¥å­
        sentences = text_cleaner.split_into_sentences(text)
        
        print(f"ğŸ“‹ å¥å­åˆ†å‰²ç»“æœ:")
        for j, sentence in enumerate(sentences, 1):
            print(f"   {j}. {sentence}")
        
        print(f"âœ… å…± {len(sentences)} ä¸ªå¥å­ï¼Œå¹³å‡é•¿åº¦: {sum(len(s) for s in sentences) / len(sentences):.1f} å­—ç¬¦")

def test_performance_benchmark():
    """æ€§èƒ½åŸºå‡†æµ‹è¯•"""
    print("\nâš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•")
    print("=" * 60)
    
    import time
    
    # ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®
    test_data = []
    for i in range(100):
        test_data.append(f"""# æµ‹è¯•æ–‡æ¡£ {i} ğŸ“ˆ

## æ­¥éª¤ {i}ï¼š
1. **æ“ä½œä¸€** - è¿™æ˜¯ç¬¬ä¸€ä¸ªæ“ä½œ ğŸ˜Š
2. **æ“ä½œäºŒ** - è¿™æ˜¯ç¬¬äºŒä¸ªæ“ä½œ âš¡
3. **æ“ä½œä¸‰** - è¿™æ˜¯ç¬¬ä¸‰ä¸ªæ“ä½œ ğŸ’¡

æ³¨æ„äº‹é¡¹ï¼š
â€¢ æ³¨æ„å®‰å…¨ âš ï¸
â€¢ è°¨æ…æ“ä½œ ğŸ’ª
â€¢ æœ‰é—®é¢˜è”ç³»å®¢æœ ğŸ“

ã€é‡è¦æç¤ºã€‘è¯·ä»”ç»†é˜…è¯»ã€Šç”¨æˆ·åè®®ã€‹ï¼ˆç¬¬{i}æ¡ï¼‰å’Œã€Šé£é™©æç¤ºã€‹ï¼ï¼ï¼

å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹æ‚¨æœ‰å¸®åŠ©ï¼ ğŸ‰""")
    
    print(f"ğŸ“Š æµ‹è¯•æ•°æ®: {len(test_data)} ä¸ªæ–‡æ¡£")
    
    # æµ‹è¯•æ¸…ç†æ€§èƒ½
    start_time = time.time()
    cleaned_results = []
    for text in test_data:
        cleaned = text_cleaner.clean_for_tts(text)
        cleaned_results.append(cleaned)
    end_time = time.time()
    
    total_time = (end_time - start_time) * 1000  # è½¬æ¢ä¸ºæ¯«ç§’
    avg_time = total_time / len(test_data)
    
    print(f"â±ï¸  æ€§èƒ½ç»Ÿè®¡:")
    print(f"   - æ€»å¤„ç†æ—¶é—´: {total_time:.2f} æ¯«ç§’")
    print(f"   - å¹³å‡å¤„ç†æ—¶é—´: {avg_time:.2f} æ¯«ç§’/æ–‡æ¡£")
    print(f"   - å¤„ç†é€Ÿåº¦: {len(test_data) / (total_time / 1000):.1f} æ–‡æ¡£/ç§’")
    
    # ç»Ÿè®¡ä¼˜åŒ–æ•ˆæœ
    total_original_length = sum(len(text) for text in test_data)
    total_cleaned_length = sum(len(text) for text in cleaned_results)
    total_reduction = total_original_length - total_cleaned_length
    reduction_rate = (total_reduction / total_original_length) * 100
    
    print(f"ğŸ“ˆ ä¼˜åŒ–æ•ˆæœ:")
    print(f"   - åŸå§‹æ€»é•¿åº¦: {total_original_length} å­—ç¬¦")
    print(f"   - æ¸…ç†åæ€»é•¿åº¦: {total_cleaned_length} å­—ç¬¦")
    print(f"   - æ€»å‡å°‘: {total_reduction} å­—ç¬¦ ({reduction_rate:.1f}%)")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ¤ TTSæ–‡æœ¬ä¼˜åŒ–æµ‹è¯•å¥—ä»¶")
    print("=" * 60)
    
    try:
        # TTSä¼˜åŒ–æµ‹è¯•
        test_tts_optimization()
        
        # å¥å­æµç•…åº¦æµ‹è¯•
        test_sentence_flow()
        
        # æ€§èƒ½åŸºå‡†æµ‹è¯•
        test_performance_benchmark()
        
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆ!")
        print("\nğŸ“‹ æ€»ç»“:")
        print("âœ… æ–‡æœ¬æ¸…ç†åŠŸèƒ½æ­£å¸¸å·¥ä½œ")
        print("âœ… èƒ½å¤Ÿæœ‰æ•ˆç§»é™¤è¡¨æƒ…ç¬¦å·ã€ç‰¹æ®Šç¬¦å·ã€æ ¼å¼æ ‡è®°")
        print("âœ… èƒ½å¤Ÿå°†åˆ—è¡¨æ ¼å¼è½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€")
        print("âœ… æ€§èƒ½è‰¯å¥½ï¼Œå¤„ç†é€Ÿåº¦å¿«")
        print("âœ… é€‚åˆTTSè¯­éŸ³åˆæˆ")
        
    except Exception as e:
        print(f"\nâŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main() 