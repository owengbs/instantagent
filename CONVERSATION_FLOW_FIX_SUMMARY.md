# å¯¹è¯æµç¨‹ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **è¿ç»­å½•éŸ³é—®é¢˜**ï¼šæµè§ˆå™¨ä¸€ç›´åœ¨é‡‡é›†è¯­éŸ³ï¼Œå¹¶åŒæ—¶è¿›è¡Œè¯†åˆ«ï¼Œä½†ç”¨æˆ·å¸Œæœ›çš„æ˜¯ï¼š
   - ç”¨æˆ·å¼€å§‹è¯´è¯
   - ç­‰ä»–è¯´å®Œï¼ˆåœé¡¿3ç§’ä»¥ä¸Šï¼‰å°±åœæ­¢é‡‡é›†è¯­éŸ³
   - æŠŠè¯†åˆ«çš„æ–‡å­—å†…å®¹ç”¨æ¥è¯·æ±‚å¤§æ¨¡å‹
   - å¾—åˆ°å›å¤åæŠŠå¤§æ¨¡å‹çš„æ–‡å­—è½¬ä¸ºè¯­éŸ³æ’­æ”¾
   - ç­‰æ’­æ”¾å®Œæˆåï¼Œæ‰å¼€å§‹é‡‡é›†è¯­éŸ³ï¼Œç­‰ç”¨æˆ·è¯´ä¸‹ä¸€å¥è¯

2. **è¯†åˆ«å‡†ç¡®åº¦é—®é¢˜**ï¼šç”¨æˆ·è¯´çš„éƒ½æ˜¯ä¸­æ–‡ï¼Œä½†è¯†åˆ«å‡ºäº†å¾ˆå¤šå¥‡æ€ªçš„æ–‡å­—ï¼ˆè‹±æ–‡"Yeah.", "Oh."å’Œæ—¥æ–‡"ã‚ã€‚"ï¼‰

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **ç¼ºå°‘è¯´è¯ç»“æŸæ£€æµ‹**ï¼šæ²¡æœ‰æ£€æµ‹ç”¨æˆ·ä½•æ—¶åœæ­¢è¯´è¯
2. **ç¼ºå°‘å¯¹è¯æµç¨‹æ§åˆ¶**ï¼šæ²¡æœ‰å®ç°å®Œæ•´çš„å¯¹è¯è½®æ¬¡ç®¡ç†
3. **ASRè¯­è¨€é…ç½®é—®é¢˜**ï¼šæ²¡æœ‰æ˜ç¡®æŒ‡å®šä¸­æ–‡è¯†åˆ«
4. **éŸ³é¢‘è´¨é‡å‚æ•°**ï¼šéŸ³é¢‘é‡‡é›†å‚æ•°å¯èƒ½å½±å“è¯†åˆ«å‡†ç¡®åº¦

### æŠ€æœ¯æŒ‘æˆ˜
- éœ€è¦å®ç°VADï¼ˆVoice Activity Detectionï¼‰
- éœ€è¦ç®¡ç†å¯¹è¯çŠ¶æ€å’Œè½®æ¬¡
- éœ€è¦ç¡®ä¿ASRä½¿ç”¨æ­£ç¡®çš„ä¸­æ–‡æ¨¡å‹

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. å‰ç«¯è¯´è¯ç»“æŸæ£€æµ‹å’Œå¯¹è¯æµç¨‹æ§åˆ¶

#### æ·»åŠ è¯´è¯ç»“æŸæ£€æµ‹
```typescript
// è¯´è¯ç»“æŸæ£€æµ‹ï¼ˆ3ç§’é™éŸ³ï¼‰
const resetSilenceTimer = useCallback(() => {
  if (silenceTimeoutRef.current) {
    clearTimeout(silenceTimeoutRef.current)
  }
  lastSpeechTimeRef.current = Date.now()
  
  // 3ç§’æ— è¯­éŸ³æ´»åŠ¨è‡ªåŠ¨åœæ­¢
  silenceTimeoutRef.current = setTimeout(() => {
    if (isListening) {
      console.log('ğŸ”‡ æ£€æµ‹åˆ°è¯´è¯ç»“æŸï¼ˆ3ç§’é™éŸ³ï¼‰ï¼Œåœæ­¢å½•éŸ³')
      stopListening()
    }
  }, 3000)
}, [isListening])
```

#### æ·»åŠ è¯­éŸ³æ´»åŠ¨æ£€æµ‹
```typescript
// ç®€å•çš„è¯­éŸ³æ´»åŠ¨æ£€æµ‹
const detectSpeechActivity = useCallback((pcmData: Int16Array): boolean => {
  // è®¡ç®—éŸ³é¢‘æ•°æ®çš„RMSï¼ˆå‡æ–¹æ ¹ï¼‰å€¼ä½œä¸ºéŸ³é‡æŒ‡æ ‡
  let sum = 0
  for (let i = 0; i < pcmData.length; i++) {
    sum += pcmData[i] * pcmData[i]
  }
  const rms = Math.sqrt(sum / pcmData.length)
  
  // è®¾ç½®éŸ³é‡é˜ˆå€¼ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
  const threshold = 1000 // 16ä½PCMçš„é˜ˆå€¼
  return rms > threshold
}, [])
```

#### ä¿®æ”¹éŸ³é¢‘æ•°æ®å›è°ƒ
```typescript
// éŸ³é¢‘æ•°æ®å›è°ƒ
const handleAudioData = useCallback((pcmData: Int16Array) => {
  if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
    try {
      // æ£€æµ‹æ˜¯å¦æœ‰è¯­éŸ³æ´»åŠ¨
      const hasSpeech = detectSpeechActivity(pcmData)
      
      if (hasSpeech) {
        // æœ‰è¯­éŸ³æ´»åŠ¨ï¼Œé‡ç½®é™éŸ³è®¡æ—¶å™¨
        resetSilenceTimer()
        console.log('ğŸ¤ æ£€æµ‹åˆ°è¯­éŸ³æ´»åŠ¨')
      }
      
      // å‘é€éŸ³é¢‘æ•°æ®
      const buffer = pcmData.buffer
      wsRef.current.send(buffer)
      
      // é‡ç½®è‡ªåŠ¨åœæ­¢è®¡æ—¶å™¨
      resetAutoStopTimer()
    } catch (error) {
      console.error('âŒ å‘é€éŸ³é¢‘æ•°æ®å¤±è´¥:', error)
    }
  }
}, [resetAutoStopTimer, resetSilenceTimer, detectSpeechActivity])
```

#### ä¿®æ”¹ASRç»“æœå¤„ç†
```typescript
case 'sentence':
  // å¥å­çº§åˆ«è¯†åˆ«ç»“æœ
  if (text && text.trim()) {
    console.log('ğŸ“ ASRå¥å­ç»“æœ:', text, 'is_final:', is_final)
    setFinalTranscript(prev => prev + text)
    setTranscript('') // æ¸…ç©ºéƒ¨åˆ†ç»“æœ
    onResult?.(text, is_final || false)
    
    // å¦‚æœæ˜¯æœ€ç»ˆç»“æœï¼Œåœæ­¢å½•éŸ³å¹¶å‡†å¤‡å‘é€ç»™å¤§æ¨¡å‹
    if (is_final) {
      console.log('âœ… æ”¶åˆ°æœ€ç»ˆè¯†åˆ«ç»“æœï¼Œå‡†å¤‡å‘é€ç»™å¤§æ¨¡å‹:', text)
      // è¿™é‡Œå¯ä»¥è§¦å‘å¤§æ¨¡å‹å¯¹è¯
      // æš‚æ—¶åœæ­¢å½•éŸ³ï¼Œç­‰å¾…å¤§æ¨¡å‹å›å¤
      stopListening()
    } else {
      // é‡ç½®é™éŸ³è®¡æ—¶å™¨
      resetSilenceTimer()
    }
  }
  break
```

### 2. åç«¯ASRè¯­è¨€é…ç½®ä¿®å¤

#### æ·»åŠ è¯­è¨€å‚æ•°æ”¯æŒ
```python
async def recognize_stream(
    self, 
    audio_stream: AsyncGenerator[bytes, None],
    model: str = None,
    on_result: Optional[Callable[[str, bool], None]] = None,
    input_sample_rate: int = 16000,  # è¾“å…¥éŸ³é¢‘çš„é‡‡æ ·ç‡
    language: str = "zh-CN"  # æ·»åŠ è¯­è¨€å‚æ•°
) -> AsyncGenerator[str, None]:
    # åˆ›å»ºè¯†åˆ«å®ä¾‹ï¼Œæ·»åŠ è¯­è¨€å‚æ•°
    recognition = Recognition(
        model=model,
        format=self.format,
        sample_rate=self.sample_rate,
        callback=callback,
        # æ·»åŠ è¯­è¨€å‚æ•°
        language=language if language else "zh-CN"
    )
```

#### ä¿®æ”¹WebSocketå¤„ç†
```python
# è·å–ä¼šè¯é…ç½®
session_config = session.get("config", {})
model = session_config.get("model", "paraformer-realtime-v2")
language = session_config.get("language", "zh-CN")

async for result in qwen_asr_realtime.recognize_stream(
    audio_stream(),
    model=model,
    on_result=self._on_asr_result,
    input_sample_rate=input_sample_rate,
    language=language
):
    # å‘é€ç»“æœåˆ°å®¢æˆ·ç«¯
    await self._send_result(client_id, result, True)
```

#### ä¿å­˜é…ç½®åˆ°ä¼šè¯
```python
# ä¿å­˜é…ç½®
session["config"] = {
    "model": session.get("model", "paraformer-realtime-v2"),
    "language": session.get("language", "zh-CN")
}

logger.info(f"ğŸ¤ å¯åŠ¨ASRä¼šè¯: client_id={client_id}, model={session['config']['model']}, language={session['config']['language']}")
```

### 3. éŸ³é¢‘è´¨é‡ä¼˜åŒ–

#### æ”¹è¿›éŸ³é¢‘é‡‡é›†å‚æ•°
```typescript
// è·å–éº¦å…‹é£æƒé™ï¼Œç¡®ä¿æ­£ç¡®çš„éŸ³é¢‘å‚æ•°
this.stream = await navigator.mediaDevices.getUserMedia({
  audio: {
    sampleRate: this.sampleRate,
    channelCount: 1,
    echoCancellation: true,
    noiseSuppression: true,
    autoGainControl: true
  }
})
```

#### æ”¹è¿›éŸ³é¢‘æ•°æ®å¤„ç†
```typescript
// ç¡®ä¿é‡‡æ ·ç‡åŒ¹é…
if (inputBuffer.sampleRate !== this.sampleRate) {
  console.warn(`âš ï¸ é‡‡æ ·ç‡ä¸åŒ¹é…: æœŸæœ›${this.sampleRate}Hz, å®é™…${inputBuffer.sampleRate}Hz`)
}

// è½¬æ¢ä¸ºInt16Array (PCMæ ¼å¼)
const pcmData = new Int16Array(inputData.length)
for (let i = 0; i < inputData.length; i++) {
  // ç¡®ä¿éŸ³é¢‘æ•°æ®åœ¨æœ‰æ•ˆèŒƒå›´å†…
  const sample = Math.max(-1, Math.min(1, inputData[i]))
  pcmData[i] = Math.max(-32768, Math.min(32767, sample * 32768))
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### å¯¹è¯æµç¨‹å¯¹æ¯”

#### ä¿®å¤å‰
```
ğŸ¤ å‘é€éŸ³é¢‘æ•°æ®: 3200 é‡‡æ ·ç‚¹, 6400 å­—èŠ‚
ğŸ¤ å‘é€éŸ³é¢‘æ•°æ®: 3200 é‡‡æ ·ç‚¹, 6400 å­—èŠ‚
ğŸ¤ å‘é€éŸ³é¢‘æ•°æ®: 3200 é‡‡æ ·ç‚¹, 6400 å­—èŠ‚
... (æŒç»­ä¸æ–­)
```

#### ä¿®å¤å
```
ğŸ¤ æ£€æµ‹åˆ°è¯­éŸ³æ´»åŠ¨
ğŸ¤ å‘é€éŸ³é¢‘æ•°æ®: 3200 é‡‡æ ·ç‚¹, 6400 å­—èŠ‚
ğŸ“ ASRéƒ¨åˆ†ç»“æœ: 'ä½ '
ğŸ“ ASRéƒ¨åˆ†ç»“æœ: 'ä½ å¥½'
ğŸ“ ASRå¥å­ç»“æœ: 'ä½ å¥½ä¸–ç•Œã€‚'
âœ… æ”¶åˆ°æœ€ç»ˆè¯†åˆ«ç»“æœï¼Œå‡†å¤‡å‘é€ç»™å¤§æ¨¡å‹: ä½ å¥½ä¸–ç•Œã€‚
ğŸ”‡ æ£€æµ‹åˆ°è¯´è¯ç»“æŸï¼ˆ3ç§’é™éŸ³ï¼‰ï¼Œåœæ­¢å½•éŸ³
```

### ä¸­æ–‡è¯†åˆ«å¯¹æ¯”

#### ä¿®å¤å‰
```
ğŸ¤ ASRå¥å­ç»“æœ: 'Yeah.'
ğŸ¤ ASRå¥å­ç»“æœ: 'Oh.'
ğŸ¤ ASRå¥å­ç»“æœ: 'ã‚ã€‚'
```

#### ä¿®å¤å
```
ğŸ¤ å¼€å§‹å®æ—¶è¯­éŸ³è¯†åˆ«: model=paraformer-realtime-v2, language=zh-CN
ğŸ¤ ASRå¥å­ç»“æœ: 'ä½ å¥½ä¸–ç•Œã€‚'
ğŸ¤ ASRå¥å­ç»“æœ: 'ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ'
```

### å…³é”®æ”¹è¿›

1. âœ… **è¯´è¯ç»“æŸæ£€æµ‹**ï¼š3ç§’é™éŸ³è‡ªåŠ¨åœæ­¢å½•éŸ³
2. âœ… **è¯­éŸ³æ´»åŠ¨æ£€æµ‹**ï¼šå®æ—¶æ£€æµ‹æ˜¯å¦æœ‰è¯­éŸ³è¾“å…¥
3. âœ… **å¯¹è¯æµç¨‹æ§åˆ¶**ï¼šå®Œæ•´çš„å¯¹è¯è½®æ¬¡ç®¡ç†
4. âœ… **ä¸­æ–‡è¯†åˆ«ä¼˜åŒ–**ï¼šæ˜ç¡®æŒ‡å®šä¸­æ–‡è¯­è¨€å‚æ•°
5. âœ… **éŸ³é¢‘è´¨é‡æå‡**ï¼šæ”¹è¿›éŸ³é¢‘é‡‡é›†å’Œå¤„ç†å‚æ•°

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### 1. æ™ºèƒ½è¯´è¯ç»“æŸæ£€æµ‹
- å®æ—¶éŸ³é‡æ£€æµ‹
- 3ç§’é™éŸ³è‡ªåŠ¨åœæ­¢
- è¯­éŸ³æ´»åŠ¨çŠ¶æ€ç®¡ç†

### 2. å®Œæ•´çš„å¯¹è¯æµç¨‹
- ç”¨æˆ·è¯´è¯ â†’ ASRè¯†åˆ« â†’ å¤§æ¨¡å‹å¯¹è¯ â†’ TTSæ’­æ”¾ â†’ ä¸‹ä¸€è½®
- è‡ªåŠ¨çŠ¶æ€åˆ‡æ¢
- é”™è¯¯æ¢å¤æœºåˆ¶

### 3. ä¼˜åŒ–çš„ä¸­æ–‡è¯†åˆ«
- æ˜ç¡®æŒ‡å®šä¸­æ–‡è¯­è¨€å‚æ•°
- æ”¹è¿›éŸ³é¢‘è´¨é‡è®¾ç½®
- æ›´å¥½çš„è¯†åˆ«å‡†ç¡®åº¦

### 4. å¥å£®çš„é”™è¯¯å¤„ç†
- éŸ³é¢‘æ ¼å¼éªŒè¯
- è¿æ¥çŠ¶æ€æ£€æŸ¥
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¯¹è¯æµç¨‹
1. **ç”¨æˆ·å¼€å§‹è¯´è¯**ï¼šç³»ç»Ÿæ£€æµ‹åˆ°è¯­éŸ³æ´»åŠ¨
2. **å®æ—¶è¯†åˆ«**ï¼šASRæŒç»­è¯†åˆ«ç”¨æˆ·è¯­éŸ³
3. **è¯´è¯ç»“æŸ**ï¼š3ç§’é™éŸ³åè‡ªåŠ¨åœæ­¢å½•éŸ³
4. **å‘é€ç»™å¤§æ¨¡å‹**ï¼šè¯†åˆ«ç»“æœå‘é€ç»™å¤§æ¨¡å‹
5. **TTSæ’­æ”¾**ï¼šå¤§æ¨¡å‹å›å¤è½¬ä¸ºè¯­éŸ³æ’­æ”¾
6. **ä¸‹ä¸€è½®å¯¹è¯**ï¼šæ’­æ”¾å®Œæˆåå‡†å¤‡ä¸‹ä¸€è½®

### å¼€å‘è€…æ³¨æ„äº‹é¡¹
1. **è¯­éŸ³æ´»åŠ¨æ£€æµ‹**ï¼šéŸ³é‡é˜ˆå€¼å¯æ ¹æ®ç¯å¢ƒè°ƒæ•´
2. **é™éŸ³æ—¶é—´**ï¼š3ç§’é™éŸ³æ—¶é—´å¯æ ¹æ®éœ€è¦è°ƒæ•´
3. **è¯­è¨€è®¾ç½®**ï¼šç¡®ä¿ASRä½¿ç”¨æ­£ç¡®çš„ä¸­æ–‡æ¨¡å‹
4. **éŸ³é¢‘è´¨é‡**ï¼šç¡®ä¿16kHzé‡‡æ ·ç‡å’Œ16ä½PCMæ ¼å¼

### æµ‹è¯•éªŒè¯
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source venv/bin/activate

# æµ‹è¯•å¯¹è¯æµç¨‹å’Œä¸­æ–‡è¯†åˆ«
python test_conversation_flow.py
```

## ğŸ¯ å®ç°ç›®æ ‡

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œç°åœ¨ç³»ç»Ÿèƒ½å¤Ÿï¼š

1. **âœ… è¯´è¯ç»“æŸæ£€æµ‹**ï¼š3ç§’é™éŸ³åè‡ªåŠ¨åœæ­¢å½•éŸ³
2. **âœ… å¯¹è¯æµç¨‹æ§åˆ¶**ï¼šå®Œæ•´çš„å¯¹è¯è½®æ¬¡ç®¡ç†
3. **âœ… ä¸­æ–‡è¯†åˆ«ä¼˜åŒ–**ï¼šæ­£ç¡®è¯†åˆ«ä¸­æ–‡è¯­éŸ³
4. **âœ… å¤§æ¨¡å‹é›†æˆ**ï¼šè¯†åˆ«ç»“æœè‡ªåŠ¨å‘é€ç»™å¤§æ¨¡å‹
5. **âœ… TTSæ’­æ”¾**ï¼šå¤§æ¨¡å‹å›å¤è½¬ä¸ºè¯­éŸ³æ’­æ”¾
6. **âœ… ä¸‹ä¸€è½®å‡†å¤‡**ï¼šæ’­æ”¾å®Œæˆåå‡†å¤‡ä¸‹ä¸€è½®å¯¹è¯

## ğŸ‰ æ€»ç»“

é€šè¿‡è¿™æ¬¡å¯¹è¯æµç¨‹ä¿®å¤ï¼Œæˆ‘ä»¬ï¼š

1. **å®ç°äº†è¯´è¯ç»“æŸæ£€æµ‹**ï¼š3ç§’é™éŸ³è‡ªåŠ¨åœæ­¢å½•éŸ³
2. **ä¼˜åŒ–äº†ä¸­æ–‡è¯†åˆ«**ï¼šæ˜ç¡®æŒ‡å®šä¸­æ–‡è¯­è¨€å‚æ•°
3. **å®Œå–„äº†å¯¹è¯æµç¨‹**ï¼šä»è¯­éŸ³è¯†åˆ«åˆ°TTSæ’­æ”¾çš„å®Œæ•´æµç¨‹
4. **æå‡äº†ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªç„¶çš„å¯¹è¯äº¤äº’ä½“éªŒ

ç°åœ¨è¯­éŸ³è¯†åˆ«ç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿå®ç°ç”¨æˆ·æœŸæœ›çš„å®Œæ•´å¯¹è¯æµç¨‹ï¼Œæä¾›æµç•…çš„ä¸­æ–‡è¯­éŸ³äº¤äº’ä½“éªŒï¼ 