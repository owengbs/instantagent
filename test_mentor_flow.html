<!DOCTYPE html>
<html>
<head>
    <title>导师选择流程测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .mentors { display: flex; gap: 10px; margin: 10px 0; }
        .mentor { padding: 10px; border: 1px solid #ddd; cursor: pointer; }
        .mentor.selected { background: #e7f3ff; border-color: #0066cc; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; height: 200px; overflow-y: scroll; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>导师选择流程测试</h1>
    
    <div class="step">
        <h3>步骤1: 选择导师</h3>
        <div class="mentors" id="mentorList">
            <!-- 将动态生成 -->
        </div>
        <button onclick="saveSelectedMentors()">保存选择</button>
    </div>
    
    <div class="step">
        <h3>步骤2: 检查localStorage</h3>
        <button onclick="checkLocalStorage()">检查存储</button>
        <pre id="localStorageContent"></pre>
    </div>
    
    <div class="step">
        <h3>步骤3: 模拟发送到后端</h3>
        <button onclick="simulateSendToBackend()">模拟发送</button>
    </div>
    
    <div class="step">
        <h3>日志</h3>
        <div class="log" id="log"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        const DEFAULT_MENTORS = [
            {
                id: 'buffett',
                name: '沃伦·巴菲特',
                title: '伯克希尔·哈撒韦CEO',
                description: '价值投资之父'
            },
            {
                id: 'soros',
                name: '乔治·索罗斯',
                title: '量子基金创始人',
                description: '金融大鳄'
            },
            {
                id: 'munger',
                name: '查理·芒格',
                title: '伯克希尔·哈撒韦副主席',
                description: '多元思维模型倡导者'
            },
            {
                id: 'krugman',
                name: '保罗·克鲁格曼',
                title: '诺贝尔经济学奖得主',
                description: '新贸易理论创始人'
            }
        ];

        let selectedMentors = [];

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function renderMentors() {
            const mentorList = document.getElementById('mentorList');
            mentorList.innerHTML = '';
            
            DEFAULT_MENTORS.forEach(mentor => {
                const div = document.createElement('div');
                div.className = 'mentor';
                div.setAttribute('data-id', mentor.id);
                div.innerHTML = `
                    <strong>${mentor.name}</strong><br>
                    <small>${mentor.title}</small>
                `;
                div.onclick = () => toggleMentor(mentor);
                mentorList.appendChild(div);
            });
            
            log('导师列表已渲染');
        }

        function toggleMentor(mentor) {
            const index = selectedMentors.findIndex(m => m.id === mentor.id);
            if (index > -1) {
                selectedMentors.splice(index, 1);
                log(`取消选择: ${mentor.name}`);
            } else {
                selectedMentors.push(mentor);
                log(`选择: ${mentor.name}`);
            }
            
            updateMentorDisplay();
        }

        function updateMentorDisplay() {
            document.querySelectorAll('.mentor').forEach(div => {
                const mentorId = div.getAttribute('data-id');
                if (selectedMentors.some(m => m.id === mentorId)) {
                    div.classList.add('selected');
                } else {
                    div.classList.remove('selected');
                }
            });
            
            log(`当前选择: [${selectedMentors.map(m => m.name).join(', ')}]`);
        }

        function saveSelectedMentors() {
            if (selectedMentors.length === 0) {
                alert('请至少选择一位导师');
                return;
            }
            
            localStorage.setItem('selectedMentors', JSON.stringify(selectedMentors));
            log(`已保存 ${selectedMentors.length} 位导师到localStorage`);
            log(`导师ID: [${selectedMentors.map(m => m.id).join(', ')}]`);
        }

        function checkLocalStorage() {
            const savedMentors = localStorage.getItem('selectedMentors');
            const contentDiv = document.getElementById('localStorageContent');
            
            if (savedMentors) {
                try {
                    const mentors = JSON.parse(savedMentors);
                    contentDiv.textContent = JSON.stringify(mentors, null, 2);
                    log(`localStorage中有 ${mentors.length} 位导师`);
                    log(`导师ID: [${mentors.map(m => m.id).join(', ')}]`);
                } catch (error) {
                    contentDiv.textContent = '解析错误: ' + error.message;
                    log(`解析localStorage失败: ${error.message}`);
                }
            } else {
                contentDiv.textContent = '没有找到savedMentors';
                log('localStorage中没有找到selectedMentors');
            }
        }

        function simulateSendToBackend() {
            const savedMentors = localStorage.getItem('selectedMentors');
            if (!savedMentors) {
                log('错误: localStorage中没有selectedMentors数据');
                return;
            }
            
            try {
                const mentors = JSON.parse(savedMentors);
                const mentorIds = mentors.map(mentor => mentor.id);
                
                log('=== 模拟发送到后端 ===');
                log(`原始数据: ${JSON.stringify(mentors.map(m => ({id: m.id, name: m.name})))}`);
                log(`提取的ID: [${mentorIds.join(', ')}]`);
                
                // 模拟WebSocket发送
                const message = {
                    type: 'set_selected_mentors',
                    mentors: mentorIds
                };
                
                log(`WebSocket消息: ${JSON.stringify(message)}`);
                log('=== 模拟发送完成 ===');
                
            } catch (error) {
                log(`处理数据失败: ${error.message}`);
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            renderMentors();
            log('页面已加载，请按步骤测试');
        };
    </script>
</body>
</html>
